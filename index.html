<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Language Guessr</title>

  <!-- Google Font -->
  <link
    href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap"
    rel="stylesheet"
  />

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    /*******************************************************
     * 1. RESET & GLOBAL
     *******************************************************/
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html,
    body {
      height: 100%;
      background: #000; /* Pure black background for the overall UI */
      font-family: "Montserrat", sans-serif;
      color: #fff;
    }

    a,
    button {
      transition: all 0.3s ease;
    }

    /*******************************************************
     * 2. LAYOUT
     *******************************************************/
    body {
      display: flex;
      flex-direction: column;
    }

    header {
      background: #000;
      text-align: center;
      padding: 1rem 0;
      border-bottom: 1px solid #444;
    }

    header h1 {
      font-size: 1.8rem;
      margin-bottom: 0.25rem;
      color: #fff;
    }

    header p {
      color: #aaa;
      font-size: 0.95rem;
    }

    @media (max-width: 768px) {
      header h1 {
        font-size: 1.3rem;
      }
      header p {
        font-size: 0.85rem;
      }
    }

    #game-container {
      flex: 1;
      display: flex;
      flex-direction: row;
      position: relative;
    }

    /*******************************************************
     * 3. SIDEBAR - Visible on desktop, hidden on mobile
     *******************************************************/
    #sidebar {
      width: 300px;
      background: #111;
      border-right: 1px solid #444;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      justify-content: start;
      overflow-y: auto;
    }

    .game-info {
      margin-bottom: 1rem;
      font-size: 0.95rem;
      line-height: 1.4;
    }

    .game-info p {
      margin-bottom: 0.5rem;
    }

    .previous-rounds {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid #444;
      flex: 1;
    }

    .round-result {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.5rem;
    }

    .round-result span {
      font-size: 1rem;
    }

    .round-result.success span:last-child {
      color: #32cd32; /* lime green check */
    }

    .round-result.fail span:last-child {
      color: #ff4444; /* red X */
    }

    @media (max-width: 768px) {
      #sidebar {
        display: none; /* Hide on mobile */
      }
    }

    /*******************************************************
     * 4. MOBILE INFO (TOP-LEFT)
     *    Only visible on mobile, replaces the hidden sidebar
     *******************************************************/
    #mobile-info {
      display: none; /* hidden by default, shown on mobile */
    }
    @media (max-width: 768px) {
      #mobile-info {
        display: block;
        position: absolute;
        top: 20px;
        left: 20px;
        background: rgba(17, 17, 17, 0.8);
        padding: 0.8rem;
        border-radius: 6px;
        font-size: 0.9rem;
        z-index: 1002;
      }
      #mobile-info p {
        margin-bottom: 0.2rem;
      }
    }

    /*******************************************************
     * 5. MAP
     *******************************************************/
    #map {
      flex: 1;
      position: relative;
    }

    /* Lock the map so it doesn't wrap around horizontally */
    .leaflet-container {
      background: #000;
    }

    /*******************************************************
     * 6. MAP CONTROLS (BOTTOM-RIGHT)
     *******************************************************/
    .map-controls {
      position: absolute;
      bottom: 20px;
      right: 20px;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      z-index: 1001; /* Above the map tiles */
    }

    .btn {
      background: #222;
      color: #fff;
      border: 1px solid #444;
      border-radius: 4px;
      padding: 0.75rem 1.25rem;
      font-size: 1rem;
      cursor: pointer;
    }
    .btn:hover {
      background: #333;
    }
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Make buttons bigger on mobile */
    @media (max-width: 768px) {
      .btn {
        font-size: 1.2rem;
        padding: 1rem 1.5rem;
      }
    }

    /*******************************************************
     * 7. MODAL
     *******************************************************/
    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .modal {
      background: #111;
      color: #fff;
      padding: 2rem;
      border-radius: 8px;
      max-width: 500px;
      width: 80%;
      text-align: center;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
    }

    .modal h2 {
      margin-bottom: 1rem;
      font-size: 1.6rem;
      color: #fff;
    }

    .modal p {
      margin-bottom: 1rem;
      font-size: 1.1rem;
      color: #aaa;
    }

    .modal .btn {
      margin-top: 0.5rem;
      background: #222;
    }

    /* Make modal bigger on mobile (up to 90% width) */
    @media (max-width: 768px) {
      .modal {
        width: 90%;
        padding: 2rem 1.5rem;
      }
      .modal h2 {
        font-size: 1.4rem;
      }
      .modal p {
        font-size: 1rem;
      }
    }

  </style>
</head>
<body>
  <header>
    <h1>Language Guessr</h1>
    <p>Listen to the language and drop your pin on the map!</p>
  </header>

  <div id="game-container">
    <!-- SIDEBAR (hidden on mobile) -->
    <aside id="sidebar">
      <div class="game-info">
        <p><strong>Round:</strong> <span id="round-num">1</span> / <span id="total-rounds">5</span></p>
        <p><strong>Score:</strong> <span id="score">0</span></p>
      </div>

      <div class="previous-rounds" id="previous-rounds"></div>
    </aside>

    <!-- Mobile Info (shows only on mobile) -->
    <div id="mobile-info">
      <p><strong>Round:</strong> <span id="round-num-mobile">1</span> / <span id="total-rounds-mobile">5</span></p>
      <p><strong>Score:</strong> <span id="score-mobile">0</span></p>
    </div>

    <!-- MAP -->
    <div id="map"></div>

    <!-- MAP CONTROLS (bottom-right) -->
    <div class="map-controls">
      <button class="btn" id="play-sound-btn">Play Sound</button>
      <button class="btn" id="confirm-btn" disabled>Confirm Guess</button>
    </div>
  </div>

  <!-- MODAL -->
  <div class="modal-backdrop" id="modal-backdrop">
    <div class="modal" id="modal-content">
      <h2 id="modal-title"></h2>
      <p id="modal-msg"></p>
      <button class="btn" id="modal-close-btn">Next</button>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script>
    /********************************************************
     * 1. GLOBAL CONSTANTS & STATE
     ********************************************************/
    const TOTAL_ROUNDS = 5; // Number of rounds
    const MAX_DISTANCE_KM = 1000; // Threshold for awarding points

    let COUNTRIES = []; // Will be loaded from JSON
    let score = 0;
    let round = 1;
    let currentCountry = null;

    let map = null;
    let guessMarker = null; // Player's guess
    let correctMarker = null; // Correct location marker

    // Each entry: { roundNumber, countryName, isCorrect }
    const roundResults = [];

    /********************************************************
     * 2. INITIALIZE THE MAP
     *    - Using standard OSM tile layer
     *    - Lock map boundaries so there's no horizontal wrap
     ********************************************************/
    function initMap() {
      map = L.map("map", {
        worldCopyJump: false, // no repeated wraps
        maxBoundsViscosity: 1.0
      }).setView([20, 0], 2);

      // Restrict the map from panning infinitely
      map.setMaxBounds([
        [-85, -180],
        [85, 180]
      ]);

      // Standard OSM tile layer (not dark)
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution:
          'Map data © <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors',
        maxZoom: 19
      }).addTo(map);

      // On map click, place or move the guess marker
      map.on("click", onMapClick);
    }

    function onMapClick(e) {
      if (!guessMarker) {
        guessMarker = L.marker(e.latlng, { draggable: true }).addTo(map);
      } else {
        guessMarker.setLatLng(e.latlng);
      }
      // Enable "Confirm Guess" once a marker is placed
      document.getElementById("confirm-btn").disabled = false;
    }

    /********************************************************
     * 3. GAME FUNCTIONS
     ********************************************************/
    function startGame() {
      // Start first round
      round = 1;
      score = 0;
      document.getElementById("score").textContent = "0";
      document.getElementById("score-mobile").textContent = "0";
      roundResults.length = 0; // Clear old results

      startRound();
    }

    function startRound() {
      // Update UI for desktop
      document.getElementById("round-num").textContent = round;
      document.getElementById("total-rounds").textContent = TOTAL_ROUNDS;
      // Update UI for mobile
      document.getElementById("round-num-mobile").textContent = round;
      document.getElementById("total-rounds-mobile").textContent = TOTAL_ROUNDS;

      document.getElementById("confirm-btn").disabled = true;

      // Clear any old markers from previous round
      if (guessMarker) {
        map.removeLayer(guessMarker);
        guessMarker = null;
      }
      if (correctMarker) {
        map.removeLayer(correctMarker);
        correctMarker = null;
      }

      // Pick a random country from the loaded JSON
      currentCountry =
        COUNTRIES[Math.floor(Math.random() * COUNTRIES.length)];

      console.log("DEBUG: Correct country:", currentCountry.name);
    }

    // Text-to-speech
    function playSound() {
      if (!currentCountry) return;

      // Pick a random phrase from the sampleTexts
      const { sampleTexts, voiceLang } = currentCountry;
      const randomText =
        sampleTexts[Math.floor(Math.random() * sampleTexts.length)];

      const utterance = new SpeechSynthesisUtterance(randomText);

      // Attempt to set a matching voice, if available
      const voices = speechSynthesis.getVoices();
      const selectedVoice = voices.find((v) => v.lang === voiceLang);
      if (selectedVoice) {
        utterance.voice = selectedVoice;
      } else {
        console.warn(
          "No exact voice match found for",
          voiceLang,
          "Falling back to default."
        );
      }

      speechSynthesis.speak(utterance);
    }

    // Confirm guess, calculate distance, show result
    function confirmGuess() {
      if (!guessMarker || !currentCountry) return;

      const guessLatLng = guessMarker.getLatLng();
      const distance = haversineDistance(
        [guessLatLng.lat, guessLatLng.lng],
        [currentCountry.lat, currentCountry.lng]
      );

      let pointsAwarded = 0;
      let isCorrect = false;

      if (distance <= MAX_DISTANCE_KM) {
        pointsAwarded = 100;
        isCorrect = true;
      }

      score += pointsAwarded;
      document.getElementById("score").textContent = score.toString();
      document.getElementById("score-mobile").textContent = score.toString();

      // Show correct location
      correctMarker = L.marker([currentCountry.lat, currentCountry.lng], {
        title: "Correct Location"
      }).addTo(map);

      // Prepare modal
      const modalTitle = document.getElementById("modal-title");
      const modalMsg = document.getElementById("modal-msg");

      if (isCorrect) {
        modalTitle.textContent = "Correct!";
        modalMsg.textContent = `You were ${distance.toFixed(
          1
        )} km away. +${pointsAwarded} points.`;
      } else {
        modalTitle.textContent = "Wrong!";
        modalMsg.textContent = `You were ${distance.toFixed(
          1
        )} km away. No points awarded.`;
      }

      // Record round result
      roundResults.push({
        roundNumber: round,
        countryName: currentCountry.name,
        isCorrect: isCorrect
      });
      renderPreviousRounds();

      openModal();
    }

    function nextRound() {
      closeModal();
      round++;
      if (round > TOTAL_ROUNDS) {
        showFinalScore();
      } else {
        startRound();
      }
    }

    function showFinalScore() {
      const modalTitle = document.getElementById("modal-title");
      const modalMsg = document.getElementById("modal-msg");

      modalTitle.textContent = "Game Over!";
      modalMsg.textContent = `Your final score is ${score}. Refresh or start again to play again.`;

      openModal();
      document.getElementById("modal-close-btn").style.display = "none";
      // Disable main buttons
      document.getElementById("play-sound-btn").disabled = true;
      document.getElementById("confirm-btn").disabled = true;
    }

    // Update the "previous rounds" list in the sidebar
    function renderPreviousRounds() {
      const container = document.getElementById("previous-rounds");
      container.innerHTML = "";

      roundResults.forEach((res) => {
        const div = document.createElement("div");
        div.classList.add("round-result");
        div.classList.add(res.isCorrect ? "success" : "fail");

        div.innerHTML = `
          <span>Round ${res.roundNumber}: ${res.countryName}</span>
          <span>${res.isCorrect ? "✔" : "✘"}</span>
        `;
        container.appendChild(div);
      });
    }

    /********************************************************
     * 4. MODAL
     ********************************************************/
    function openModal() {
      document.getElementById("modal-backdrop").style.display = "flex";
    }

    function closeModal() {
      document.getElementById("modal-backdrop").style.display = "none";
      document.getElementById("modal-close-btn").style.display = "inline-block";
    }

    /********************************************************
     * 5. HELPER: HAVERSINE DISTANCE
     ********************************************************/
    function haversineDistance([lat1, lon1], [lat2, lon2]) {
      const R = 6371; // Earth radius in km
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const radLat1 = toRad(lat1);
      const radLat2 = toRad(lat2);

      const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.sin(dLon / 2) *
          Math.sin(dLon / 2) *
          Math.cos(radLat1) *
          Math.cos(radLat2);

      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;

      function toRad(value) {
        return (value * Math.PI) / 180;
      }
    }

    /********************************************************
     * 6. ON LOAD
     ********************************************************/
    window.addEventListener("load", () => {
      initMap();

      // 1) Fetch countries data from JSON (same folder)
      fetch("./countries.json")
        .then((res) => res.json())
        .then((data) => {
          COUNTRIES = data;
          // 2) Now we have data, start the game
          startGame();
        })
        .catch((err) => {
          console.error("Error loading countries.json:", err);
        });

      // Wire up buttons
      document
        .getElementById("play-sound-btn")
        .addEventListener("click", playSound);
      document
        .getElementById("confirm-btn")
        .addEventListener("click", confirmGuess);
      document
        .getElementById("modal-close-btn")
        .addEventListener("click", nextRound);
    });
  </script>
</body>
</html>
