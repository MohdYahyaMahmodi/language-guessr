<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Language Guessr</title>

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">

  <!-- Leaflet CSS -->
  <link 
    rel="stylesheet" 
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
    crossorigin=""
  />

  <style>
    /* ------------------------------- 
       1. RESET & GLOBAL STYLES
    --------------------------------- */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      font-family: 'Montserrat', sans-serif;
      background: linear-gradient(135deg, #74ABE2, #5563DE);
      color: #333;
    }

    /* Smooth transitions for hover effects */
    a, button {
      transition: all 0.3s ease;
    }

    /* Hide default Leaflet attribution text shadow */
    .leaflet-control-attribution {
      text-shadow: none;
    }

    /* ------------------------------- 
       2. PAGE LAYOUT
    --------------------------------- */
    body {
      display: flex;
      flex-direction: column;
    }

    header {
      text-align: center;
      padding: 1rem 0;
      background: #fff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    header h1 {
      font-size: 1.8rem;
      margin-bottom: 0.25rem;
      color: #333;
    }

    header p {
      color: #666;
      font-size: 0.95rem;
    }

    #game-container {
      flex: 1;
      display: flex;
      flex-direction: row;
      overflow: hidden;
    }

    /* ------------------------------- 
       3. SIDEBAR
    --------------------------------- */
    #sidebar {
      width: 320px;
      max-width: 320px;
      min-width: 240px;
      background: #fdfdfd;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      z-index: 1000; /* Sit on top of map if needed */
    }

    .game-info {
      margin-bottom: 1rem;
    }

    .game-info p {
      font-size: 1rem;
      margin-bottom: 0.3rem;
    }

    /* Previous Rounds List */
    .previous-rounds {
      margin-top: 1rem;
      border-top: 1px solid #eee;
      padding-top: 1rem;
      flex: 1;
      overflow-y: auto;
    }

    .round-result {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
    }
    .round-result span {
      font-size: 1.2rem;
      margin-left: 0.5rem;
    }
    .round-result.success span {
      color: green;
    }
    .round-result.fail span {
      color: red;
    }

    /* ------------------------------- 
       4. MAP
    --------------------------------- */
    #map {
      flex: 1;
      position: relative;
    }

    #map .leaflet-tile {
      filter: brightness(0.95);
    }

    /* ------------------------------- 
       5. BUTTONS
    --------------------------------- */
    .btn {
      display: inline-block;
      background: #5563DE;
      color: #fff;
      padding: 0.75rem 1.25rem;
      border: none;
      border-radius: 4px;
      text-align: center;
      cursor: pointer;
      font-size: 1rem;
      text-decoration: none;
      margin-bottom: 0.5rem;
    }

    .btn:hover {
      background-color: #4652c8;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* ------------------------------- 
       6. MODAL
    --------------------------------- */
    .modal-backdrop {
      position: fixed;
      top: 0; 
      left: 0;
      width: 100%; 
      height: 100%;
      background: rgba(0,0,0,0.6);
      display: none; /* Hidden by default */
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .modal {
      background: #fff;
      padding: 2rem;
      border-radius: 8px;
      max-width: 400px;
      width: 80%;
      text-align: center;
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    .modal h2 {
      margin-bottom: 1rem;
      font-size: 1.4rem;
      color: #333;
    }

    .modal p {
      margin-bottom: 1rem;
      font-size: 1rem;
      color: #555;
    }

    .modal .btn {
      margin-top: 0.5rem;
    }
  </style>
</head>
<body>
  <header>
    <h1>Language Guessr</h1>
    <p>Listen to the spoken language, then drop a pin on the map to guess the country!</p>
  </header>

  <div id="game-container">
    <!-- SIDEBAR -->
    <aside id="sidebar">
      <div>
        <div class="game-info">
          <p><strong>Round:</strong> <span id="round-num">1</span> / <span id="total-rounds">5</span></p>
          <p><strong>Score:</strong> <span id="score">0</span></p>
        </div>

        <!-- Buttons -->
        <button class="btn" id="play-sound-btn">Play Sound</button>
        <button class="btn" id="confirm-btn" disabled>Confirm Guess</button>

        <!-- List of Previous Rounds -->
        <div class="previous-rounds" id="previous-rounds"></div>
      </div>
    </aside>

    <!-- MAP -->
    <div id="map"></div>
  </div>

  <!-- MODAL -->
  <div class="modal-backdrop" id="modal-backdrop">
    <div class="modal" id="modal-content">
      <h2 id="modal-title"></h2>
      <p id="modal-msg"></p>
      <button class="btn" id="modal-close-btn">Next</button>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script 
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" 
    crossorigin="">
  </script>

  <script>
    /**
     * 1. COUNTRY & LANGUAGE DATA
     * - name: name of the country
     * - lat/lng: approximate center
     * - voiceLang: valid speech code for the browser's Web Speech API
     * - sampleTexts: an array of random phrases in that language, 
     *                not referencing the country name
     */
    const COUNTRIES = [
      {
        name: "France",
        lat: 46.2276,
        lng: 2.2137,
        voiceLang: "fr-FR",
        sampleTexts: [
          "J'aime voyager et rencontrer de nouvelles personnes.",
          "Le fromage et le pain sont mes aliments préférés.",
          "Il fait très beau aujourd'hui, n'est-ce pas ?",
          "Je suis ravi de faire votre connaissance."
        ]
      },
      {
        name: "Spain",
        lat: 40.4637,
        lng: -3.7492,
        voiceLang: "es-ES",
        sampleTexts: [
          "Me encanta escuchar música y bailar.",
          "¿Dónde está la estación de tren más cercana?",
          "Este lugar es muy bonito y tranquilo.",
          "¡Qué día tan maravilloso tenemos hoy!"
        ]
      },
      {
        name: "Germany",
        lat: 51.1657,
        lng: 10.4515,
        voiceLang: "de-DE",
        sampleTexts: [
          "Ich trinke gern Kaffee am Morgen.",
          "Wo ist das nächste Museum?",
          "Das Wetter ist heute wirklich angenehm.",
          "Ich lerne gerade eine neue Sprache."
        ]
      },
      {
        name: "Italy",
        lat: 41.8719,
        lng: 12.5674,
        voiceLang: "it-IT",
        sampleTexts: [
          "Amo la pasta e la pizza!",
          "Che bella giornata per una passeggiata.",
          "Stavo leggendo un libro molto interessante.",
          "Mi piace incontrare gente nuova."
        ]
      },
      {
        name: "Brazil",
        lat: -14.2350,
        lng: -51.9253,
        voiceLang: "pt-BR",
        sampleTexts: [
          "Eu adoro dançar e cantar no chuveiro.",
          "Onde fica a padaria mais próxima?",
          "O clima está muito agradável hoje.",
          "Estou animado para conhecer pessoas diferentes."
        ]
      },
      {
        name: "Japan",
        lat: 36.2048,
        lng: 138.2529,
        voiceLang: "ja-JP",
        sampleTexts: [
          "毎朝お茶を飲むのが大好きです。",
          "近くに有名なレストランはありますか？",
          "今日は本当にいい天気ですね。",
          "新しい趣味を探しているところです。"
        ]
      },
      // Add more countries if you like...
    ];

    const TOTAL_ROUNDS = 5;       // how many rounds to play
    const MAX_DISTANCE_KM = 1000; // threshold (km) for awarding points

    /**
     * 2. GAME STATE
     */
    let score = 0;
    let round = 1;
    let currentCountry = null;
    let map = null;
    let guessMarker = null;   // Marker for player's guess
    let correctMarker = null; // Marker for correct location

    // We'll store the results here to display in the sidebar
    // Each entry: { roundNumber, countryName, isCorrect }
    const roundResults = [];

    /**
     * 3. INITIALIZE THE MAP (Leaflet)
     */
    function initMap() {
      // Create the map, center on Earth with a low zoom to see many countries
      map = L.map('map').setView([20, 0], 2);

      // Add the OpenStreetMap tiles
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution:
          'Map data © <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors',
      }).addTo(map);

      // When user clicks on the map, place or move the guessMarker
      map.on('click', onMapClick);
    }

    function onMapClick(e) {
      if (!guessMarker) {
        guessMarker = L.marker(e.latlng, { draggable: true }).addTo(map);
      } else {
        guessMarker.setLatLng(e.latlng);
      }
      // Once the user has placed a guess, enable the "Confirm" button
      document.getElementById("confirm-btn").disabled = false;
    }

    /**
     * 4. START A NEW ROUND
     */
    function startRound() {
      // Update UI
      document.getElementById("round-num").textContent = round;
      document.getElementById("total-rounds").textContent = TOTAL_ROUNDS;
      document.getElementById("confirm-btn").disabled = true;

      // Clear any old markers
      if (guessMarker) {
        map.removeLayer(guessMarker);
        guessMarker = null;
      }
      if (correctMarker) {
        map.removeLayer(correctMarker);
        correctMarker = null;
      }

      // Pick a random country from the list
      currentCountry = COUNTRIES[Math.floor(Math.random() * COUNTRIES.length)];

      console.log("DEBUG: The correct country is:", currentCountry.name);
    }

    /**
     * 5. PLAY SOUND (text-to-speech)
     *    - Select a random phrase from currentCountry.sampleTexts
     *    - Use currentCountry.voiceLang as the TTS voice if available
     */
    function playSound() {
      if (!currentCountry) return;

      // Pick a random phrase from the sampleTexts array
      const texts = currentCountry.sampleTexts;
      const randomText = texts[Math.floor(Math.random() * texts.length)];

      const utterance = new SpeechSynthesisUtterance(randomText);

      // Attempt to set the voice if the browser supports it
      const availableVoices = speechSynthesis.getVoices();
      const selectedVoice = availableVoices.find(
        (voice) => voice.lang === currentCountry.voiceLang
      );
      if (selectedVoice) {
        utterance.voice = selectedVoice;
      } else {
        console.warn("No exact voice match found for", currentCountry.voiceLang, ". Falling back to default.");
      }

      // Speak
      speechSynthesis.speak(utterance);
    }

    /**
     * 6. CONFIRM GUESS
     *    - Calculate distance from guess to the correct location
     *    - If within threshold => add points
     *    - Show modal with result
     *    - Store the result to display in the "previous rounds" list
     */
    function confirmGuess() {
      if (!guessMarker || !currentCountry) return;

      const guessLatLng = guessMarker.getLatLng();
      const distance = haversineDistance(
        [guessLatLng.lat, guessLatLng.lng],
        [currentCountry.lat, currentCountry.lng]
      );

      let pointsAwarded = 0;
      let isCorrect = false;
      if (distance <= MAX_DISTANCE_KM) {
        // For simplicity, let's do a flat 100 points if within threshold
        pointsAwarded = 100;
        isCorrect = true;
      }

      // Update total score
      score += pointsAwarded;
      document.getElementById("score").textContent = score;

      // Show the correct location on the map
      correctMarker = L.marker([currentCountry.lat, currentCountry.lng], {
        title: "Correct location",
      }).addTo(map);

      // Prepare the modal
      const modalTitle = document.getElementById("modal-title");
      const modalMsg = document.getElementById("modal-msg");

      if (isCorrect) {
        modalTitle.textContent = "Correct!";
        modalMsg.textContent = `You were ${distance.toFixed(
          1
        )} km away. You earned ${pointsAwarded} points.`;
      } else {
        modalTitle.textContent = "Wrong!";
        modalMsg.textContent = `You were ${distance.toFixed(
          1
        )} km away. No points awarded.`;
      }

      // Save round result for the sidebar
      roundResults.push({
        roundNumber: round,
        countryName: currentCountry.name,
        isCorrect: isCorrect
      });
      renderPreviousRounds();

      openModal();
    }

    /**
     * 7. NEXT ROUND OR END GAME
     */
    function nextRound() {
      closeModal();
      round++;
      if (round > TOTAL_ROUNDS) {
        // Game over
        showFinalScore();
      } else {
        startRound();
      }
    }

    function showFinalScore() {
      const modalTitle = document.getElementById("modal-title");
      const modalMsg = document.getElementById("modal-msg");

      modalTitle.textContent = "Game Over!";
      modalMsg.textContent = `Your final score is ${score}. Refresh the page to play again.`;

      openModal();
      // Hide the 'Next' button
      document.getElementById("modal-close-btn").style.display = "none";
      // Disable main buttons
      document.getElementById("play-sound-btn").disabled = true;
      document.getElementById("confirm-btn").disabled = true;
    }

    /**
     * 8. RENDER PREVIOUS ROUNDS
     *    - Show each round with the country name and a check or X
     */
    function renderPreviousRounds() {
      const container = document.getElementById('previous-rounds');
      container.innerHTML = ""; // Clear current list

      roundResults.forEach((result) => {
        const div = document.createElement('div');
        div.classList.add('round-result');
        div.classList.add(result.isCorrect ? 'success' : 'fail');

        div.innerHTML = `
          <span>Round ${result.roundNumber}: ${result.countryName}</span>
          <span>${result.isCorrect ? '✔' : '✘'}</span>
        `;
        container.appendChild(div);
      });
    }

    /**
     * 9. MODAL HANDLING
     */
    function openModal() {
      document.getElementById("modal-backdrop").style.display = "flex";
    }

    function closeModal() {
      document.getElementById("modal-backdrop").style.display = "none";
    }

    /**
     * 10. DISTANCE CALCULATION (Haversine)
     *     Returns distance in kilometers between two lat/lng points
     */
    function haversineDistance([lat1, lon1], [lat2, lon2]) {
      const R = 6371; // Earth radius in km
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const radLat1 = toRad(lat1);
      const radLat2 = toRad(lat2);

      const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.sin(dLon / 2) *
          Math.sin(dLon / 2) *
          Math.cos(radLat1) *
          Math.cos(radLat2);

      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;

      function toRad(value) {
        return (value * Math.PI) / 180;
      }
    }

    /**
     * 11. ON LOAD
     */
    window.addEventListener('load', () => {
      initMap();
      startRound();

      // Wire up buttons
      document.getElementById("play-sound-btn").addEventListener("click", playSound);
      document.getElementById("confirm-btn").addEventListener("click", confirmGuess);
      document.getElementById("modal-close-btn").addEventListener("click", nextRound);
    });
  </script>
</body>
</html>
